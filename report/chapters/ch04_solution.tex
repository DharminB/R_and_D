%!TEX root = ../report.tex

\chapter{Implementation}

We are using b-it-bots ROS code base\cite{bitbots} for robot model, static navigation ROS packages
and configuration files.

\section{Moving obstacles}%
\label{sec:moving_obstacles}

The moving obstacles are animated with the help of a gazebo plugin modified from\cite{animatedBox}.
The plugin takes information like key frames and position and orientation of object at each
key frame and animates the objects in gazebo. It also advertises the position and orientation
of the obstacles at each iteration to a gazebo channel. This is then read by a ROS node and 
published as a ROS message every 15 ms.
Additionally we have created small modular ROS nodes which 
\begin{itemize}
    \item calculate relative position of obstacles w.r.t.\ robot
    \item calculate instantaneous velocity of obstacles
    \item publish robot's position in the world
    \item converting moving obstacle information to costmap (Refer~\ref{sec:obstacle_trajectory_to_costmap})
\end{itemize} 
to be used if a planner needs it.
The source code for these plugins and helper nodes are available at~\cite{movingObstacleGazebo}

\section{Obstacle trajectory to costmap}%
\label{sec:obstacle_trajectory_to_costmap}
    This ROS node script (\texttt{obs\_to\_costmap}) calculates the instantaneous velocity of the 
    moving obstacle and creates fake occupancy information for the future track of the moving obstacle. 
    This tricks a planner into thinking certain areas are occupied whereas, in reality, they are not. 
    This node can be used with any static local planner which considers costmap\cite{costmap} information.
    
    We find that choosing appropriate time duration (\texttt{lookahead\_time}) for extrapolating future trajectory is a trade
    off. If the time is too short, the planner might collide with the obstacle. On the other
    hand, if the time is too long, the planner's path may be blocked completely and it will be forced
    to wait until the costmap clears (increases travel time). Even with a
    configured value, the planner might fail for another scenario. For open spaces, a good rule of
    thumb would be to consider deceleration limits and sensing range of the robot. The \texttt{lookahead\_time} 
    is chosen to be 3 seconds. This value works well with the robot's acceleration and its laser range.


\section{Planners to be evaluated}%
\label{sec:planners_to_be_evaluated}

\subsection{TEB local planner}%
\label{sub:teb_local_planner}
This planner\cite{tebLocalPlanner} is implementation of Timed elastic band 
approach\cite{rosmann2015planning}.
The planner is used with ROS navigation~\cite{rosnavigation}. It is used as local
planner in \texttt{move\_base} which publishes \texttt{cmd\_vel} message to control robot. 
The planner makes small changes to the path generated by the global planner.
To get the information about the dynamic obstacles, teb local planner uses \texttt{obstacles} 
ROS message from costmap\_converter\cite{costmapconverter}. It can contain the information about 
the shape of the robot (as polygon), its position and its velocity. This information is provided 
to teb local planner by one of the helper nodes from~\ref{sec:moving_obstacles}.
\texttt{move\_base} listens to ROS topic \texttt{move\_base\_simple/goal} to get the position
and orientation of the goal.

\subsection{Spline based planner}%
\label{sub:spline_based_planner}
This planner\cite{omgtools} is implementation of Spline based planner approach\cite{mercy2017spline}.
By default the planner works in its own environment and simulator. The planner can be 
incorporated with ROS framework\cite{p3dxMotionplanner}. We have, however, not made it 
compatible with ROS navigation.
Even though the planner is incorporated with ROS, it does not use gazebo simulator. The 
plans are in its own simulator and the wrapper built around this code are used to translate the 
information from one simulation to another. This could be a major handicap for this planner 
because it uses 2 simulation simultaneously which will slow down the simulation and increase
the response time.
The planner simulator requires the size of rooms and position and shape of obstacles before
starting. This may become a problem if the robot does not have information about each moving
obstacle. For the purpose of this experiment, we provide the planner with information about
all moving obstacle no matter if the robot can sense the obstacle with its sensors or not.

\subsection{DWA local planner}%
\label{sub:dynamic_window_approach_planner}
DWA local planner\cite{dwa} is implementation of Dynamic window approach~\cite{fox1997dynamic}.
This planner works as a local planner in ROS navigation\cite{rosnavigation}. The DWA approach
alone cannot work without the global planner because it only consider a limited area around
the robot to plan a local path. The planner needs to be configured to make changes to the
global plan up to a certain amount.
By default it is used for static motion planning. This puts DWA planner at a major disadvantage
because it cannot predict the position of moving obstacle in future. 
For this reason, we couple the planner with a \texttt{obs\_to\_costmap} which changes the costmap for the 
environment according to the velocity of the moving obstacles. 

\subsection{EBand local planner}%
\label{sub:eband_local_planner}
This planner\cite{eband} is implementation of Elastic band approach\cite{quinlan1993elastic}.
Similar to DWA planner and teb planner, EBand local planner also works as a local planner
in ROS navigation\cite{rosnavigation}. This is because it makes changes to the path generated
by the global planner. 
The planner gets the information of the obstacles from costmap and does not use any other 
source of information.

\subsection{EBand with obs\_to\_costmap}%
\label{sub:eband2_local_planner}
Similar to DWA local planner, we couple EBand planner\cite{eband} with \texttt{obs\_to\_costmap}.
As the planner only considers costmap information, the new costmap will provide information
about the future poses of the moving obstacles to the planner. We expect this approach to 
perform better than Eband (\ref{sub:eband_local_planner}) in terms of number of collisions and worse in
terms of time taken to reach goal. We expect that because this approach will be forced to 
choose safer trajectory which might force the robot to wait for the path to clear or force 
the robot to go around the moving obstacle rather than passing it.
From now on, we will refer to EBand with obs\_to\_costmap as Eband2.

